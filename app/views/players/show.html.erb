<% content_for :title, "#{@player.riot_id} - LoL Wrapped" %>

<div class="w-full max-w-2xl" data-controller="update-player" data-update-player-url-value="<%= update_player_path(region: @player.path_params[:region], riot_id_slug: @player.riot_id_slug) %>" data-update-player-last-updated-value="<%= @player.last_synced_at&.iso8601 %>">
  <div class="mb-8">
    <%= link_to root_path, class: "text-sm font-medium text-stone-400 transition-colors hover:text-stone-200" do %>
      ← Back to lookup
    <% end %>
  </div>

  <div class="space-y-6 rounded-xl bg-stone-800/50 p-8 shadow-xl">
    <div class="flex items-center justify-between gap-3">
      <div class="flex items-center gap-3 min-w-0">
        <div class="flex h-14 w-14 shrink-0 items-center justify-center overflow-hidden rounded-full bg-stone-500/30">
          <% if @player.profile_icon_url.present? %>
            <%= image_tag @player.profile_icon_url, alt: @player.riot_id, class: "h-full w-full object-cover" %>
          <% else %>
            <span class="text-2xl font-bold text-white">
              <%= @player.riot_id.to_s[0].upcase %>
            </span>
          <% end %>
        </div>
        <div class="min-w-0">
          <h1 class="text-2xl font-bold text-white"><%= @player.riot_id %></h1>
          <p class="text-sm text-white">
            Region: <span class="text-white"><%= @player.region_display %></span>
            <% if @player.summoner_level.present? %>
              • Level <%= @player.summoner_level %>
            <% end %>
            <% if @player.solo_rank_entry.present? %>
              • <span class="font-medium text-white"><%= @player.rank_display(@player.solo_rank_entry) %></span>
            <% end %>
          </p>
        </div>
      </div>
      <button type="button" data-action="click->update-player#update" data-update-player-target="button" class="shrink-0 rounded-lg border border-stone-600 bg-stone-800 px-4 py-2 text-sm font-medium text-white transition-colors hover:border-stone-400 hover:bg-stone-700 hover:text-white focus:outline-none focus:ring-2 focus:ring-stone-400 focus:ring-offset-2 focus:ring-offset-stone-900 disabled:pointer-events-none disabled:cursor-not-allowed disabled:border-stone-700 disabled:bg-stone-900 disabled:text-white/60 disabled:opacity-75">
        Refresh profile
      </button>
    </div>

    <div class="space-y-3 border-t border-stone-600 pt-6" data-controller="recap" data-recap-ingest-url-value="<%= ingest_year_player_path(@player.id) %>" data-recap-compute-url-value="<%= compute_recap_player_path(@player.id) %>" data-recap-status-url-value="<%= recap_statuses_player_path(@player.id) %>" data-recap-statuses-value="<%= (@player.recap_statuses || {}).to_json %>" data-recap-failure-reasons-value="<%= (@player.recap_failure_reasons || {}).to_json %>">
      <h2 class="text-lg font-semibold text-white">Year Recap (Wrapped-style)</h2>
      <p class="text-sm text-white">Generate your "most played with" teammates for the previous year. Processing happens in the background and may take a few minutes.</p>
      <div class="flex flex-wrap items-center gap-3">
        <button type="button" data-recap-target="generateButton" data-action="click->recap#generate" class="rounded-lg border border-stone-500 bg-stone-600/50 px-4 py-2 text-sm font-medium text-white transition-colors hover:border-stone-400 hover:bg-stone-500/50 focus:outline-none focus:ring-2 focus:ring-stone-400 focus:ring-offset-2 focus:ring-offset-stone-900 disabled:pointer-events-none disabled:cursor-not-allowed disabled:border-stone-700 disabled:bg-stone-900 disabled:text-white/60 disabled:opacity-75">
          Generate recap
        </button>
        <%= link_to "View recap", player_year_recap_path(region: @player.path_params[:region], riot_id_slug: @player.path_params[:riot_id_slug], year: Time.current.year - 1), data: { recap_target: "viewButton", action: "click->recap#navigateToRecap" }, class: "rounded-lg border border-stone-600 px-4 py-2 text-sm font-medium text-white hover:bg-stone-800 focus:outline-none focus:ring-2 focus:ring-stone-400 focus:ring-offset-2 focus:ring-offset-stone-900 no-underline inline-block disabled:pointer-events-none disabled:opacity-75" %>
        <button type="button" data-recap-target="computeButton" data-action="click->recap#compute" class="rounded border border-stone-500 px-3 py-1.5 text-xs font-medium text-white hover:bg-stone-800 hover:text-white disabled:pointer-events-none disabled:cursor-not-allowed disabled:border-stone-700 disabled:bg-stone-900 disabled:text-white/60 disabled:opacity-75" title="Recompute from existing matches — faster than full regenerate, use this to refresh stats">
          Recompute
        </button>
      </div>
      <div data-recap-target="progressBlock" class="hidden rounded-lg border border-stone-600 bg-stone-900/50 px-4 py-3 text-sm">
        <div class="flex items-start gap-3">
          <div data-recap-target="progressSpinner" class="mt-0.5 shrink-0 hidden">
            <svg class="animate-spin h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </div>
          <div data-recap-target="progressContent" class="min-w-0 flex-1 space-y-1 text-stone-300"></div>
        </div>
      </div>
      <p data-recap-target="message" class="hidden text-sm"></p>
    </div>

    <div class="flex flex-wrap items-center gap-3 border-t border-stone-600 pt-6" data-controller="share-url" data-share-url-url-value="<%= player_url(@player) %>">
      <span class="text-sm text-white">Share this profile:</span>
      <div class="flex flex-1 min-w-0 items-center gap-2 rounded-lg bg-stone-900 px-3 py-2">
        <code class="truncate text-sm text-white"><%= player_url(@player) %></code>
        <button type="button" data-action="click->share-url#copy" class="shrink-0 rounded px-2 py-1 text-xs font-medium text-white hover:bg-stone-800" title="Copy link">Copy</button>
      </div>
    </div>

    <%= link_to "Look up another player", root_path, class: "inline-flex items-center gap-2 rounded-lg border border-stone-600 bg-stone-800 px-4 py-2 text-sm font-medium text-white transition-colors hover:border-stone-500 hover:bg-stone-700 focus:outline-none focus:ring-2 focus:ring-stone-400 focus:ring-offset-2 focus:ring-offset-stone-900" %>
  </div>
</div>
